"use strict";var config={url:"http://sheeprails.herokuapp.com",server:"rails",centers:{},socketLogined:!1,socketUrl:"http://sheepsocket-43181.usw1.actionbox.io:5000/ui_centers"},app=angular.module("sheepgridApp",["ngResource","ui.router","ngGrid"]);app.constant("config",config).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(a,b,c){b.otherwise("/"),a.state("default",{templateUrl:"/views/layout/default.html",controller:"DefaultCtrl","abstract":!0}).state("default.centers",{templateUrl:"./views/centers.html",controller:"CentersCtrl"}).state("default.regions",{url:"/regions/:id",templateUrl:"./views/regions.html",controller:"RegionsCtrl"}),c.html5Mode(!0).hashPrefix("!")}]),app.controller("CentersCtrl",["$scope","$location","$stateParams","$timeout","config","CenterService",function(a,b,c,d,e,f){a.$location=b,a.cellValue;var g='<div class="ngSelectionCell"><input tabindex="-1" class="ngSelectionCheckbox" type="checkbox" ng-checked="row.selected" /></div>',h='<input style="width: 90%" step="any" type="string" ng-class="\'colt\' + col.index" ng-input="COL_FIELD" ng-blur="updateEntity(col, row, cellValue)" ng-model=\'cellValue\'/>',i=[{field:"CHK",displayName:"chk",width:50,cellTemplate:g,sortable:!1,pinned:!1,enableCellEdit:!1},{field:"status",displayName:"CRUD",width:50,sortable:!1,pinned:!1,enableCellEdit:!1},{field:"link",displayName:"link",width:80,cellTemplate:"<div><button ng-click=\"goTo('/regions/', row)\">to region</button></div>"},{field:"id",displayName:"id",enableCellEdit:!1},{field:"code",displayName:"code",editableCellTemplate:h},{field:"name",displayName:"name",editableCellTemplate:h},{field:"chief",displayName:"chief",editableCellTemplate:h},{field:"address",displayName:"address",editableCellTemplate:h},{field:"phone",displayName:"phone",editableCellTemplate:h}];a.$watch("uip_center",function(){a.gridInit&&!a.gridCenter&&(a.gridInit(f,i),a.getDatas())},!0)}]),app.controller("NavbarCtrl",["$scope","$location","$state",function(a,b,c){a.$state=c,a.$location=b,c.go("default.centers"),a.goTo=function(b,d){"/"==b||(d?c.go("default.regions",{id:d.entity.id}):a.uip_center[0]&&c.go("default.centers"))}}]),app.directive("commbutton",["$compile",function(a){var b=function(a,b,c){var d='<button id="'+a+b+'" class="btn btn-primary" type="button" ng-click="'+a+"Data";return d+=c?"("+c+')"':'()"',d+=">"+a+"</button>"},c=function(c,d,e){d.html(b(e.type,e.data,e.dataset)).show(),a(d.contents())(c)};return{restrict:"E",link:c,replace:!0}}]),angular.module("sheepgridApp").directive("ngBlur",function(){return function(a,b,c){b.bind("blur",function(){a.$apply(c.ngBlur)})}}),app.factory("CenterService",["$resource","config",function(a,b){return a(b.url+"/uip_centers/:id",{id:"@id"},{update:{method:"PUT"}})}]),app.controller("RegionsCtrl",["$scope","$location","$stateParams","$timeout","$state","config","RegionService",function(a,b,c,d,e,f,g){a.$location=b,a.cellValue;var h='<div class="ngSelectionCell"><input tabindex="-1" class="ngSelectionCheckbox" type="checkbox" ng-checked="row.selected" /></div>',i='<input style="width: 90%" step="any" type="string" ng-class="\'colt\' + col.index" ng-input="COL_FIELD" ng-blur="updateEntity(col, row, cellValue)" ng-model=\'cellValue\'/>',j=[{field:"CHK",displayName:"chk",width:50,cellTemplate:h,sortable:!1,pinned:!1,enableCellEdit:!1},{field:"status",displayName:"CRUD",width:50,sortable:!1,pinned:!1,enableCellEdit:!1},{field:"uip_center_id",displayName:"uip_center_id",enableCellEdit:!1},{field:"id",displayName:"id",enableCellEdit:!1},{field:"code",displayName:"code",editableCellTemplate:i},{field:"region_code",displayName:"region_code",editableCellTemplate:i},{field:"name",displayName:"name",editableCellTemplate:i},{field:"chief",displayName:"chief",editableCellTemplate:i},{field:"address",displayName:"address",editableCellTemplate:i}];a.$watch("uip_region",function(){if(a.gridInit&&!a.gridRegion){var b={uip_center_id:c.id};a.gridInit(g,j,b),a.getDatas()}},!0),a.goHomeData=function(){e.go("default.centers")}}]),app.factory("RegionService",["$resource","config",function(a,b){return a(b.url+"/uip_regions/:id",{id:"@id"},{update:{method:"PUT"}})}]),app.factory("socket",["$rootScope","config",function(a,b){var c=null;try{c=io.connect(b.socketUrl)}catch(d){return}return c.on("connect",function(){console.log("Client has connected to the server!")}),{on:function(b,d){c.on(b,function(){var b=arguments;a.$apply(function(){d.apply(c,b)})})},emit:function(b,d,e){c.emit(b,d,function(){var b=arguments;a.$apply(function(){e&&e.apply(c,b)})})}}}]),app.filter("agoText",function(){return function(a){return moment.lang("en"),moment(a).fromNow()}}),app.controller("DefaultCtrl",["$scope",function(){}]).controller("GlobalCtrl",["$scope","$location","$state",function(a,b,c){a.$state=c,a.$location=b}]),app.directive("ngExcel",["$compile","$timeout","config","socket",function(a,b,c,d){var e,f,g,h,i,j=function(a){return'<div ng-grid="'+a+'" ng-style="myprop()"></div>'},k=function(k,l,m){f=m.id,g=m.data,k.gridInit=function(b,c,d){e=b,i=d,h=g+"s",k[f]={data:g,multiSelect:!1,enableCellSelection:!0,enableCellEditOnFocus:!0,enableRowSelection:!0,enablePinning:!0,enableSorting:!0,columnDefs:c,selectedItems:[]},l.html(j(f)).show(),a(l.contents())(k),k[f].attr=m},k.updateEntity=function(a,b,c){var d=k[g][b.rowIndex],e=k[g][b.rowIndex].status;e&&"I"==e||d[a.colDef.field]!=c&&(k[g][b.rowIndex].status="U"),b.entity[a.field]=c},k.$watch(g,function(){k.myprop=function(){var a=k[f].attr;return a?{width:a.width+"px",height:a.height+"px"}:{}}},!0),k.getDatas=function(a){var b={};a&&(b=a),e.get(b,function(a){for(var b=0;b<a[h].length;b++)a[h][b].status="R";k[g]=a[h],0==c.socketLogined&&(c.socketLogined=!0,d.emit("centers","centers"))})},k.retrieveData=function(a){i&&(a=i),k.getDatas(a)},k.insertData=function(){var a=k[f].columnDefs,c=o(a);i&&(c=p(i,c)),c.status="I",k[g].unshift(c);var d=function(){k[f].selectRow(0,!0)};b(d,500)},k.deleteData=function(){for(var a=k[f].selectedItems[0].id,b=0;b<k[g].length;b++)k[g][b].id==a&&("I"==k[g][b].status?k[g].splice(b,1):k[g][b].status="D")},k.initData=function(){if(k[f].selectedItems[0])for(var a=k[f].selectedItems[0].id,b=0;b<k[g].length;b++)if(k[g][b].id==a){for(var c=0;c<Object.keys(k[g][b]).length;c++)k[g][b][Object.keys(k[g][b])[c]]=null;break}},k.saveData=function(){for(var a=k[g],b=0;b<a.length;b++){var f=a[b].status,h=b;delete a[b].status;var i={};"I"==f?(i[g]=a[b],"spring"==c.server&&(i=a[b]),e.save(i,function(a){k[g][0].id=a[g].id,d.emit("insert",k[g][0])})):"U"==f?(i[g]=a[b],i.id=a[b].id,"spring"==c.server&&(i=i[g]),e.update(i,function(a){k[g][h]=a[g]}),d.emit("update",k[g][h])):"D"==f&&(k.uip_center.curid=a[b].id,e.delete({id:a[b].id},function(){n(k.uip_center.curid,function(a){k[g].splice(a,1)})}),d.emit("delete",k[g][h].id)),k[g][b].status="R"}};var n=function(a,b){for(var c=0;c<k[g].length;c++)if(k[g][c].id==a+""){b(c);break}},o=function(a){for(var b=angular.copy(a),c={},d=0;d<b.length;d++)b[d].field&&"link"!=b[d].field&&"CHK"!=b[d].field&&(c[b[d].field]=null);return c},p=function(a,b){for(var c=0;c<Object.keys(a).length;c++)b[Object.keys(a)[c]]=a[Object.keys(a)[c]];return b};d.on("inserted",function(a){$("#content_log").text(a),k[g].unshift(a)}),d.on("updated",function(a){$("#content_log").text(a),k.retrieveData()}),d.on("deleted",function(a){$("#content_log").text(a),n(a,function(a){k[g].splice(a,1)})})};return{restrict:"EA",link:k,replace:!0}}]);